---
title: "DSO 522 Group 5 Airbnb Pricing Analysis"
author: "Group 5 (Evelyn (Wanyi) Dong, Qiongqiong Lin, Jenny Shang, Yoki (Lingrou) Wang) "
date: "11/1/2020"
output:
  pdf_document: default
  html_document: default
  word_document: default
header-includes: \usepackage{color}
editor_options: 
  chunk_output_type: console
---

\begin{center} 
{\color{red} \textbf{DSO 522 Group 5 Airbnb Pricing Analysis}}
\end{center}

For this project, we want to study the impact of Covid-19 on the tourism industry by
analyzing past price trends of Airbnb rental properties in the city of Oakland, California, and predict future rental prices by applying different time-series forecasting methods. We choose this topic because Airbnb rentals have seen significant growth in the past but are now struggling from booking declines due to Covid-19. We are interested in using time-series forecasting to predict future prices and provide valuable insights and recommendations to help Airbnb’s stakeholders develop a solid pricing strategy to achieve customer retention and sustainable growth. From a technical standpoint, Airbnb data is readily available on Airbnb’s official website (http://insideairbnb.com/get-the-data.html). It is pre-processed, well-structured and standardized, making it the ideal dataset to conduct our analysis.

The complete dataset represents 722 Oakland average daily Airbnb house pricing from July 16, 2018 to July 16, 2020. 

## Our analysis is built on three key objectives: 
(1.) Understand the historical patterns of the Airbnb data by studying potential trends and  periodic components. 

```{r}
# import packages
library(zoo)
library(forecast)
library(ggplot2)
library(dplyr)
```

```{r}
# read data
data = read.csv("cleaned_data.csv")
# set zoo object of price
price = zoo(data$price, seq(from = as.Date("2018-07-16"), to = as.Date("2020-07-16"), by = 1))
# plot the data
autoplot(price, xlab=("Time") , ylab=("Average listing price") )
```

For example, data with daily observations might have a weekly seasonality (frequency=7) 
https://robjhyndman.com/hyndsight/seasonal-periods/

<<<<<<< HEAD
```{r Loading Data in TS format}
price.ts = ts(data$price, start = c(2018,1), frequency=7)
#price.ts = ts(data$price, start = c(2018,197), frequency=365)
ma.trailing.roll.week = rollmean(price.ts, k = 7, align = "right")
ma.trailing.roll.month = rollmean(price.ts, k = 30, align = "right")
# plot the data
autoplot(price.ts,main='Airbnb Oakland Daily Pricing', 
         xlab=("Time") , ylab=("Average listing price") )+
  autolayer(ma.trailing.roll.week,series='Weekly Aggregated')+
  autolayer(ma.trailing.roll.month,series='Monthly Aggregated')

```

1. Ask for advice on predicting daily v.s. monthly price of Oakland (monthly with very limited data points but does have monthly alternative data available)
Depends on the scope of what we wanted to use them for.
Using alternative data that's not on the same level of details - extrapolation issue - check to see what are their performances.


** Look into why 2019 sharp drop
** Qualitative external variable : use dummy variable to indicate those exceptional cases?
2. Ask for clarification on COVID impact on model buildling - seperate models for post COVID?
By looking at the data we seee a sharper decrease in 2019 compare with COVID's impact:
* Build the model without 2020, and then make predictions in 2020

- Exponential Smoothing 
```{r Smoothing}
changeofprice = read.csv("Change_of_Price.csv")
changeofprice <- ts(changeofprice$X..Change,start=c(2018,198),frequency=365)
autoplot(changeofprice,main='Change of Price Lag 1',ylab='% of Change in Price')

library(lmtest)
#AR(1)
ar1<-Arima(changeofprice,order=c(1,0,0))
coeftest(ar1)
```

We see that the coefficient is far away from 0 and P value also did not show statistical significance, which means this is not a random walk.

Key findings 
(-) The pricing data shows more variability in 2018 and 2020 than 2019. 
(-) In 2018, the price shows a donward trend in the beginning, but resumes in November and reaches a peak in December (potential reason: Thanksgiving, Christmas and New Year).
(-) In 2019, the listing price shows an upward trend. 
(-) In 2020, the listing price drops in the beginning (potential reason: covid-19); however, starting from May, the price resumes and increases. 
(-) Weekly seasonality is shown in the data. Since we only have two years data, it is hard to tell if there is a yearly seasonality. 

Since we want to analyze the effect of Covid-19, we separate the data to pre-2020 and 2020-onwards, and separately construct models for each period. 

```{r}
# Separate the two periods
pre_covid = window(price.ts, end = c(2018,534),frequency = 7)
covid = window(price.ts, start = c(2018,535), frequency = 7)
```

(2.) Explore a variety of time-series models and determine the most appropriate candidate  model on the basis of accuracy and simplicity to analyze and forecast future prices. 

For each pre- and post-covid period, we will set aside 1 week as validation set.

```{r}
nValid = 7
pre_covid_train = window(pre_covid, end = c(2018,527),
                         frequency = 7)
pre_covid_valid = window(pre_covid, start = c(2018,528),
                         frequency = 7)
```

**Model 1 - Holt-Winters Exponential Smoothing**

```{r}
# Model for pre_covid
pre_covid_hw = ets(pre_covid_train, model = "ZZZ")
summary(pre_covid_hw)
```

HW parameter: Multiplicative error, dampened-additive trend, additive seasonality.
Model shows MAPE of 0.5% on training data.

```{r}
## Plot of training data vs. fitted values
autoplot(pre_covid_train)+
  autolayer(pre_covid_hw$fitted)
```

```{r}
## Predictions
pre_covid_hw_pred = forecast(pre_covid_hw, h=7)

## Check accuracy and residuals
checkresiduals(pre_covid_hw_pred$residuals)
accuracy(pre_covid_hw_pred, pre_covid_valid)

## Plot of validation data vs. observed values
autoplot(pre_covid_train) +
  autolayer(pre_covid_valid, series = "Observed")+
  autolayer(pre_covid_hw_pred, series = "Predicted", level = 0)

autoplot(pre_covid_valid, series = "Observed")+
  autolayer(pre_covid_hw_pred, series = "Predicted", level = 0)
```

MAPE of testing set is 0.22% and it's lower than training data. Assumptions not met since residuals show non-stationarity, ACF plot shows significance at lags of approx. 7, 14, and 21 which suggests autocorrelation at these lags. The residuals are not very normally distributed.

Using this model to forecast 2020 first week would yield:

```{r}
hw_model = ets(pre_covid, model = "MAA", damped = TRUE)
hw_model_pred = forecast(hw_model, h=7)
hw_model_pred

## Accuracy
accuracy(hw_model_pred,covid[1:7])
residual = hw_model_pred$mean- covid[1:7]
residual

## Plot
autoplot(pre_covid)+
  autolayer(hw_model_pred, series = "Predicted")
```

Using this model with the full pre-Covid data as training set, we see that MAPE increased from 0.5% (training set) to 2.54% (testing set), which is 5x the error on the training set. Therefore, although we only expect the prediction to differ from the actual value by 2.54% on average, this model is not a robust model.

**We can also look at predictions for 1 month of data**

```{r}
## 1 day
nValid = 30
nTrain = length(pre_covid) - nValid
pre_covid_train_2 = window(pre_covid, end = c(2018,nTrain),
                         frequency = 7)
pre_covid_valid_2 = window(pre_covid, start = c(2018,nTrain+1),
                         frequency = 7)

pre_covid_hw_2 = ets(pre_covid_train_2, model = "ZZZ")
summary(pre_covid_hw_2) ## Same model as before (M, Ad, A)

hw_model_2 = ets(pre_covid, model = "MAA", damped = TRUE)
hw_model_pred_2 = forecast(hw_model_2, h= nValid)
hw_model_pred_2

## Accuracy
accuracy(hw_model_pred_2,covid[1:30])
residual = hw_model_pred_2$mean- covid[1:30]
residual

## Plot
autoplot(pre_covid)+
  autolayer(hw_model_pred_2, series = "Predicted", level = 0)+
  autolayer(ts(covid[1:30], start = c(2018,535), frequency = 7), series = "Observed")
```

As shown in the plot, the prediction accuracy going into 2020 is very bad, likely due to the effect of Covid and its impact on tourism. Next, we should also look at other variables that affect the Airbnb price.

**Separately construct a model for Covid period**

```{r}
## Plot
autoplot(covid)
```

From the plot, there is again a weekly seasonality and a slight downward trend.

```{r}
# Model for post-covid
nValid = 7
nTrain = length(covid)-nValid
covid_train = window(covid, end = c(2018,(length(pre_covid)+nTrain)),frequency = 7)
covid_valid = window(covid, start = c(2018,(length(pre_covid)+nTrain+1)),
                         frequency = 7)

covid_hw = ets(covid_train, model = "ZZZ")
summary(covid_hw)
```

New model to use for Covid period is M,N,M = multiplicative errors, no trend, multiplicative seasonality.

```{r}
## Plot of training data vs. fitted values
autoplot(covid_train)+
  autolayer(covid_hw$fitted)

## Predictions
covid_hw_pred = forecast(covid_hw, h=nValid)

## Check accuracy and residuals
checkresiduals(covid_hw_pred$residuals)
accuracy(covid_hw_pred, pre_covid_valid)

## Plot of validation data vs. observed values
autoplot(covid_train)+
  autolayer(covid_valid, series = "Observed") +
  autolayer(covid_hw_pred, series = "Predicted", level = 0)
```

Model is fairly accurate on the validation set with MAPE of 0.22%, which is similar to the training set. However, assumptions are violated as residuals show varying stationarity and are not normally distributed.

Using this model to predict the next week's price:

```{r}
hw_model_covid = ets(covid, model = "MNM")
hw_model_pred_covid = forecast(hw_model_covid, h= nValid)
hw_model_pred_covid

## Plot
autoplot(covid)+
  autolayer(hw_model_pred_covid, series = "Predicted", level = 0)
```

**Model 2 - ARIMA**

- ARIMA
Clearly there is a trend in the time series, which makes the time series non-stationary. As a result, we take a first-order differencing and check ACF and PACF graphs. 
```{r}
# check detrended price
price.detrend = diff(price.ts, lag = 1)
autoplot(price.detrend)
par(mfrow=c(1,2)) 
Acf(price.detrend, 150) 
Pacf(price.detrend, 150)
par(mfrow=c(1,1)) 
```
From the ACF and PACF graphs of detrended data, we can see the PACF graph cuts off and ACF graph slowly tails off. However, since the ACF graph has spikes in seasonal lags and doesn't converge to 0, this suggests a weekly seasonality pattern in the data. These also appear to be non-stationary, so we take an additional weekly difference. 

```{r}
# check detrended and deseasoned price 
price.detrend.deseason = diff(diff(price.ts, lag = 1), lag=7)
autoplot(price.detrend.deseason)
par(mfrow=c(1,2)) 
Acf(price.detrend.deseason, 150) 
Pacf(price.detrend.deseason, 150)
par(mfrow=c(1,1)) 
```
Our aim now is to find an appropriate ARIMA model baseds on the ACF and PACF graph show agove. The significant spike at lag 1 and no significant spikes immediately followed after lag 1 in the ACF suggests a non-seasonal MA(1) component, and the signiifcant spike at lag 7 in the ACF suggests a seasonal MA(1) component. Consequently, we begin with a SARIMA(0,1,1)(0,1,1)[7] model, indicating a first and seasonal difference, and non-seasonal and seasonal MA(1) components.

By analogous logic applied to the PACF, there is a significant spike in lag 1, followed by an almost significant spike at lag 2, which doesn't indicate a non-seasonal AR term that we are interested in. The significant pike at lag 7 in the PACF suggest a seasonal AR(1) component. As a result, we could have another SARIMA(0,1,0)(1,1,0)[7] model. 

By combining the AR and MA terms together, we could have a third SARIMA(0,1,1)(1,1,1)[7] model, and a fourth SARIMA(1,1,1)(1,1,1) to validate our assumption about the AR term. 

Finally, we try an AutoArima model to search over possible models.

(1) SARIMA(0,1,1)(0,1,1)[7]
```{r}
arima1 = Arima(price.ts, order=c(0,1,1), seasonal = list(order=c(0,1,1), period=7))
summary(arima1)
```
(2) SARIMA(0,1,0)(1,1,0)[7]
```{r}
arima2 = Arima(price.ts, order=c(0,1,0), seasonal = list(order=c(1,1,0), period=7))
summary(arima2)
```

(3) SARIMA(0,1,0)(1,1,1)[7]
```{r}
arima3 = Arima(price.ts, order=c(0,1,0), seasonal = list(order=c(1,1,1), period=7))
summary(arima3)
```

(4) SARIMA(1,1,1)(1,1,1)[7]
```{r}
arima4 = Arima(price.ts, order=c(1,1,1), seasonal = list(order=c(1,1,1), period=7))
summary(arima4)
```

(5) Auto ARIMA
```{r}
arima5 = auto.arima(price.ts, seasonal=TRUE, approximation = FALSE)
summary(arima5)
```

Based on the MAPE values, the best model is the third model - SARIMA(0,1,0)(1,1,1)[7]. However, it still gives a high MAPE value of 0.6184103, which indicates the predicted sales is 0.62% off the target (pretty accurate for in-sample data). By checking residuals, we find the model doesn't fit well for time before 2019 and after covid-19. As a result, our next step is to 1) partition the data into three parts and fit models accordingly 2) partition into training and validation set to check model robustness. 

(Why Auto-Arima doesn't work: https://stackoverflow.com/questions/52976059/auto-arima-in-r-error-no-seasonal-differencing-is-selected)
```{r}
mape(price.ts, m3$fitted)
```

```{r}
autoplot(price.ts)+autolayer(m3$fitted)
checkresiduals(m3)
```
**Model 3 - Neural Network Autoregression Model**

```{r}
price.ts = ts(data$price, start = c(2018,197), frequency=365)
library(xts)
library(readxl)
pre.covid<-window(price.ts,start=c(2018,197),end=c(2019,365),frequency=365)
post.covid<-window(price.ts,start=c(2020,1),frequency=365)
nValid=197
GDP<-read_xlsx("GDP.xlsm")
gdp.xts <- xts(GDP$GDP,order.by=as.Date(GDP$DATE))
gdp.daily<-na.locf(merge(gdp.xts, foo=zoo(NA, order.by=seq(start(gdp.xts), end(gdp.xts),
  "day",drop=F)))[, 1])
gdp.xreg<-gdp.daily[16:549,1]
gdp.valid<-rep(last(gdp.xreg),nValid)
ur<-read.csv("unemployment_rate.csv")
ur.xts <- xts(ur$UNRATE,order.by=as.Date(ur$DATE))
ur.daily<-na.locf(merge(ur.xts, foo=zoo(NA, order.by=seq(start(ur.xts), end(ur.xts),
  "day",drop=F)))[, 1])
ur.xreg<-ur.daily[16:549,1]
ur.valid<-rep(last(ur.xreg),nValid)
```

```{r}
# Model 1 original NNAR
set.seed(100)
m1<-nnetar(pre.covid)
m1.pred<-forecast(m1,h=nValid)
accuracy(m1.pred,post.covid)
```

```{r}
autoplot(m1.pred)+autolayer(post.covid)+autolayer(m1$fitted)
```

```{r}
## Model 2 NNAR with exogenous variable-GDP
m2<-nnetar(pre.covid,xreg = as.matrix(gdp.xreg$gdp.xts))
m2.pred<-forecast(m2,h=nValid,xreg=as.matrix(gdp.valid))
accuracy(m2.pred,post.covid)
```

```{r}
autoplot(m2.pred)+autolayer(post.covid)+autolayer(m2$fitted)
```

```{r}
## Model 3 NNAR with exogenous variable-ur
m3<-nnetar(pre.covid,xreg = as.matrix(ur.xreg$ur.xts))
m3.pred<-forecast(m3,h=nValid,xreg=as.matrix(ur.valid))
accuracy(m3.pred,post.covid)
```

```{r}
autoplot(m3.pred)+autolayer(post.covid)+autolayer(m3$fitted)
```

```{r}
## Model 4 NNAR with both of ur & GDP variables
a<-cbind(ur.xreg$ur.xts,gdp.xreg$gdp.xts)

m4<-nnetar(pre.covid,xreg=as.matrix(a))

m4.pred<-forecast(m4,h=nValid,xreg=as.matrix(cbind(ur.valid,gdp.valid)))
accuracy(m4.pred,post.covid)
```

```{r}
autoplot(m4.pred)+autolayer(post.covid)+autolayer(m4$fitted)
```

```{r}
library(forecast)
par(mfrow=c(1,2))
Acf(pre.covid)
Pacf(pre.covid)
```
ACF tails off as a damped wave pattern, Pacf cuts off at lag 36.
AR(36) p=36, P=1, k=15

```{r}
# Model 5 p=36,P=1 NNAR
m5<-nnetar(pre.covid,p=36,P=1,repeats = 15)
m5.pred<-forecast(m5,h=nValid)
accuracy(m5.pred,post.covid)
```

```{r}
autoplot(m5.pred)+autolayer(post.covid)+autolayer(m5$fitted)
```
M5 is overfitting. 
M3 is the best NNAR model.


(3.) Implement the selected candidate model to forecast both short-term and long-term Airbnb  average listing price in Oakland, California. 

## With our objectives in mind, we strive to deliver to Airbnb stakeholders a guidance on listing  price. Our analysis will focus on answering four important questions: 

(1.) What are the  determinative factors of average listing prices? 

(2.) Are there any lags between Covid-19 outbreak  and rental prices? 

(3.) Have vacation rentals recovered from the pandemic? 

(4.) Are there any  important external factors that play a role in determining the average listing price? In the future, we can apply our analysis to broader geographic areas. 

Some important variables in our study include the overall average listing price of the  selected city, and the average listing price per room type (entire home/apt or private room).  Additional variables we want to consider include the city’s unemployment rate over time, which  can be found on the U.S. Bureau of Labor Statistics website (https://www.bls.gov), as well as  general economic indicators such as GDP growth, which can be obtained from St. Louis Fed  (https://fred.stlouisfed.org/). 

At the end of our study, we expect to draw critical insights from historical patterns in  order to assist Airbnb’s stakeholders. We aim to provide Airbnb hosts with an understanding of  the determinative factors affecting property listing price such that they can adjust ahead of time,  suggest an accurate, simple and effective time-series forecasting model for Airbnb to predict  average short-term rental pricing and long-term rental pricing, and explore potential solutions for  Airbnb to identify risks and launch effective promotion or recovery plans in this Covid-19 era.

